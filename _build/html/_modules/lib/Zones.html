
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>lib.Zones &#8212; Rideshare RL 1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for lib.Zones</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># import geopandas as gpd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">deque</span>
<span class="c1"># from functools import lru_cache</span>
<span class="kn">from</span> <span class="nn">lib.Requests</span> <span class="k">import</span> <span class="n">Req</span>
<span class="kn">from</span> <span class="nn">lib.Constants</span> <span class="k">import</span> <span class="n">WARMUP_TIME_SECONDS</span><span class="p">,</span> <span class="n">BONUS</span><span class="p">,</span> <span class="n">zones_neighbors</span>
<span class="kn">from</span> <span class="nn">lib.Vehicles</span> <span class="k">import</span> <span class="n">VehState</span>

<div class="viewcode-block" id="Zone"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone">[docs]</a><span class="k">class</span> <span class="nc">Zone</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attributes:</span>
<span class="sd">        rs1: a seeded random generator for requests</span>
<span class="sd">        id: zone_id</span>
<span class="sd">        DD : daily demand (every trip)</span>
<span class="sd">        M: demand matrix</span>
<span class="sd">        D: demand volume (trips/hour)</span>
<span class="sd">        V: number of vehicles</span>
<span class="sd">        K: capacity of vehicles</span>
<span class="sd">        vehs: the list of vehicles</span>
<span class="sd">        N: number of requests</span>

<span class="sd">        mid: row number of the demand file</span>
<span class="sd">        reqs: the list of requests</span>
<span class="sd">        rejs: the list of rejected requests</span>
<span class="sd">        distance_rejs: the list of requests rejected because the distance from O to D</span>
<span class="sd">            was below the distance threshold (not included in rejs)</span>
<span class="sd">        queue: requests in the queue</span>
<span class="sd">        assign: assignment method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">rs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a zone object.</span>
<span class="sd">        @param ID: (int) zone id</span>
<span class="sd">        @param rs: random seeder</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">rs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">seed1</span> <span class="o">=</span> <span class="mi">10</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rs1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">RandomState</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rs1</span> <span class="o">=</span> <span class="n">rs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">demand</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([])</span>  <span class="c1"># demand maybe should be a time-based dictionary?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">served_demand</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">busy_vehicles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">undecided_vehicles</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fare</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DD</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surge</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonus</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_surge</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># number of times there was a surge pricing in the zone</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEMAND_ELASTICITY</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.6084</span>  <span class="c1"># https://www.nber.org/papers/w22627.pdf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusted_demand_rate</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_matched</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">revenue_generated</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_demand_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serverd_demand_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_supply_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_incoming_supply_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># for debugging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_time_demand</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="Zone.read_daily_demand"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.read_daily_demand">[docs]</a>    <span class="k">def</span> <span class="nf">read_daily_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">demand_df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the daily demand of this zone.</span>
<span class="sd">        @param demand_df: df describing demand for all zones.</span>
<span class="sd">        @return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># self.DD = demand_df.query(&quot;PULocationID == {zone_id}&quot;.format(zone_id=self.id))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DD</span> <span class="o">=</span> <span class="n">demand_df</span><span class="p">[</span><span class="n">demand_df</span><span class="p">[</span><span class="s2">&quot;PULocationID&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">]</span></div>

<div class="viewcode-block" id="Zone.calculate_demand_function"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.calculate_demand_function">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_demand_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">surge</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates demand as a function of current demand, elasticity, and surge.</span>

<span class="sd">        This should be a decreasing function of price </span>
<span class="sd">        use elasticities instead </span>
<span class="sd">        -0.6084 for NYC</span>
<span class="sd">        @param surge (float): surge multiplier.</span>
<span class="sd">        @requires surge &gt;= 1</span>

<span class="sd">        @return (float): new demand according to surge</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>
        <span class="n">change</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DEMAND_ELASTICITY</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">surge</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="p">)</span>  <span class="c1"># percent change in price * elascticity</span>
        <span class="n">new_demand</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">change</span><span class="p">)</span> <span class="o">*</span> <span class="n">base_demand</span><span class="p">)</span>  <span class="c1"># since change is negative</span>
        <span class="n">new_demand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">new_demand</span><span class="p">])</span>
        <span class="k">assert</span> <span class="n">new_demand</span> <span class="o">&lt;=</span> <span class="n">base_demand</span>
        <span class="k">return</span> <span class="n">new_demand</span></div>

<div class="viewcode-block" id="Zone.join_incoming_vehicles"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.join_incoming_vehicles">[docs]</a>    <span class="k">def</span> <span class="nf">join_incoming_vehicles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds incoming vehicle to list of incoming vehicles.</span>
<span class="sd">        @param veh (Vehicle)</span>
<span class="sd">        @return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">veh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">ozone</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">rebalancing</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">time_to_be_available</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span></div>

<div class="viewcode-block" id="Zone.join_undecided_vehicles"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.join_undecided_vehicles">[docs]</a>    <span class="k">def</span> <span class="nf">join_undecided_vehicles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds vehicle to list of undecided vehicles.</span>
<span class="sd">        @param veh (Vehicle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">veh</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">undecided_vehicles</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">locations</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">ozone</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">idle</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">rebalancing</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">veh</span><span class="o">.</span><span class="n">time_to_be_available</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">undecided_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span></div>

<div class="viewcode-block" id="Zone.remove_veh_from_waiting_list"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.remove_veh_from_waiting_list">[docs]</a>    <span class="k">def</span> <span class="nf">remove_veh_from_waiting_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">veh</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes vehicle from idle vehicles.</span>
<span class="sd">        @param veh (Vehicle)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">veh</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">veh</span><span class="p">)</span></div>

<div class="viewcode-block" id="Zone.identify_idle_vehicles"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.identify_idle_vehicles">[docs]</a>    <span class="k">def</span> <span class="nf">identify_idle_vehicles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the idle vehicles and incoming vehicle list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="p">:</span>
            <span class="c1"># if v.time_to_be_available &lt;= 0:  # not v.rebalancing and</span>
            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">VehState</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="Zone.match_veh_demand"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.match_veh_demand">[docs]</a>    <span class="k">def</span> <span class="nf">match_veh_demand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Zones</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">WARMUP_PHASE</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=-</span><span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Matches idle vehicles to requests via a queue.</span>
<span class="sd">        @param Zones:</span>
<span class="sd">        @param t: time</span>
<span class="sd">        @param WARMUP_PHASE (bool)</span>
<span class="sd">        @param penalty (float)</span>
<span class="sd">        @return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">match_w_req</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">Zones</span><span class="p">,</span> <span class="n">WARMUP_PHASE</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">status</span><span class="p">:</span>  <span class="c1"># if matched, remove from the zone&#39;s idle list</span>
                    <span class="c1">#                    print(&quot;matched&quot;)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_n_matched</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">v</span><span class="o">.</span><span class="n">ozone</span> <span class="o">==</span> <span class="n">req</span><span class="o">.</span><span class="n">dzone</span>
                    <span class="n">req</span><span class="o">.</span><span class="n">Tp</span> <span class="o">=</span> <span class="n">t</span>
                    <span class="c1"># if not WARMUP_PHASE:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">served_demand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">revenue_generated</span> <span class="o">+=</span> <span class="n">req</span><span class="o">.</span><span class="n">fare</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">surge</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not mathced by zone &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">is_AV</span><span class="p">:</span>
                        <span class="s2">&quot;should be penalized&quot;</span></div>
                        <span class="c1"># v.profits.append(penalty)</span>

    <span class="c1"># break</span>

<div class="viewcode-block" id="Zone.assign"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.assign">[docs]</a>    <span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Zones</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">WARMUP_PHASE</span><span class="p">,</span> <span class="n">penalty</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies idle vehicles, then amends history and matches vehicle demand.</span>

<span class="sd">        @param Zones:</span>
<span class="sd">        @param t:</span>
<span class="sd">        @param WARMUP_PHASE:</span>
<span class="sd">        @param penalty:</span>
<span class="sd">        @return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identify_idle_vehicles</span><span class="p">()</span>
        <span class="c1"># bookkeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_demand_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_serverd_demand_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">served_demand</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_supply_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idle_vehicles</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_incoming_supply_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">incoming_vehicles</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match_veh_demand</span><span class="p">(</span><span class="n">Zones</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">WARMUP_PHASE</span><span class="p">,</span> <span class="n">penalty</span><span class="p">)</span></div>

<div class="viewcode-block" id="Zone.set_demand_rate_per_t"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.set_demand_rate_per_t">[docs]</a>    <span class="k">def</span> <span class="nf">set_demand_rate_per_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the demand per time period.</span>
<span class="sd">        This should use self.demand as the (hourly) demand, and then generate demand according to a Poisson distribution</span>
<span class="sd">        @param t: hour of day</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># print (self.DD.shape)</span>
        <span class="n">demand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DD</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;Hour == </span><span class="si">{T}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="o">=</span><span class="n">t</span><span class="p">))</span>
        <span class="c1"># print (demand)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">=</span> <span class="n">demand</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># number of rows, i.e., transactions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="Zone.set_surge_multiplier"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.set_surge_multiplier">[docs]</a>    <span class="k">def</span> <span class="nf">set_surge_multiplier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the surge multiplier.</span>
<span class="sd">        @param m: (float) desired surge multiplier</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surge</span> <span class="o">=</span> <span class="n">m</span></div>

    <span class="c1"># @profile </span>
    <span class="k">def</span> <span class="nf">_generate_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate one request, following exponential arrival interval.</span>
<span class="sd">        @param d: demand</span>
<span class="sd">        @return: request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check if there is any demand first</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># i.e., no demand</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">D</span>

        <span class="n">scale</span> <span class="o">=</span> <span class="mf">3600.0</span> <span class="o">/</span> <span class="n">d</span>
        <span class="c1"># inter-arrival time is generated according to the exponential distribution</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rs1</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">destination</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DD</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="p">][</span><span class="s2">&quot;DOLocationID&quot;</span><span class="p">]</span>
            <span class="c1"># distance = self.DD.iloc[self.mid][&quot;trip_distance_meter&quot;]</span>
            <span class="n">fare</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">DD</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mid</span><span class="p">][</span><span class="s2">&quot;fare_amount&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">surge</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonus</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># if there are no more rows in the data</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">Req</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">0</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">Tr</span><span class="o">=</span><span class="n">WARMUP_TIME_SECONDS</span> <span class="o">+</span> <span class="n">dt</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Tr</span> <span class="o">+</span> <span class="n">dt</span><span class="p">,</span>
            <span class="n">ozone</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">dzone</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
            <span class="n">fare</span><span class="o">=</span><span class="n">fare</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1">#                    dist = distance)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">req</span>


    <span class="c1"># @profile</span>
<div class="viewcode-block" id="Zone.generate_requests_to_time"><a class="viewcode-back" href="../../lib.html#lib.Zones.Zone.generate_requests_to_time">[docs]</a>    <span class="k">def</span> <span class="nf">generate_requests_to_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate requests up to time T, following Poisson process</span>
<span class="sd">        @param T: time</span>
<span class="sd">        @return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_request</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculate_demand_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surge</span><span class="p">)</span>
        <span class="n">before_demand</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">d</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Tr</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">:</span>  <span class="c1"># self.N &lt;= self.D:</span>
            <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_request</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">req</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># self.demand.append(self.reqs[-1]) # hmm, what?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># for debugging, number of requests per 5 minutes</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_demand</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">req</span><span class="o">.</span><span class="n">Tr</span> <span class="o">-</span> <span class="n">WARMUP_TIME_SECONDS</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="n">after_demand</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">demand</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">after_demand</span> <span class="o">-</span> <span class="n">before_demand</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Huge increase in the number of requests over 30 seconds!!&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;d &quot;</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;T &quot;</span><span class="p">,</span> <span class="n">T</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;zone id &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div></div>

<span class="c1"># TODO: df_hourly_stats_over_days is what a professional driver knows</span>
<span class="c1"># TODO: df_hourly_stats is stats per hour per day. Can be the true information provided by the operator (although how are they gonna know it in advance?)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Rideshare RL</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../lib/trial.html">All about me</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lib.html">lib package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">lib</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Peyman Noursalehi.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>